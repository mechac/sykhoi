// ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ =====
const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
const userId = tg?.initDataUnsafe?.user?.id || null;

// –ü–æ–ª—É—á–∞–µ–º message_id –∏–∑ URL (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —á–µ—Ä–µ–∑ shareMessage)
const urlParams = new URLSearchParams(window.location.search);
const messageIdFromUrl = urlParams.get('message_id');

if (tg && tg.expand) {
    try {
        tg.expand();
    } catch (e) {
        console.warn('Error expanding WebApp:', e);
    }
}

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const shareMessageText = "üôà –•–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å –ª—É—á—à—É—é —Ç–µ–º—É –¥–ª—è —Ç–µ–±—è, —á—Ç–æ–±—ã —É–∫—Ä–∞—Å–∏—Ç—å Telegram?\n–ü–æ–ª—É—á–∞–π —Å–≤–æ–∏ —Ä–∞–Ω–¥–æ–º–Ω—ã–µ —Ç–µ–º—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–±—è –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞!";
const channelUrl = "https://t.me/+7tUrZjQhP-4wMGZi";

// –°–ø–∏—Å–æ–∫ —Ç–µ–º
const themes = [
  {
    name: "–¢–µ–º–Ω–∞—è —Ç–µ–º–∞",
    url: "https://t.me/addtheme/K5q9kYcFSAeFO3PI",
    preview: {
      header: "#0f1720",
      headerText: "#e6eef8",
      bg: "#07101a",
      body: "linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00))",
      incoming: "rgba(255,255,255,0.06)",
      outgoing: "#2f6bff",
      text: "#e6eef8"
    }
  },
  {
    name: "–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞",
    url: "https://t.me/addtheme/W2iF6QpKuv1yVYnT",
    preview: {
      header: "#f1f5f9",
      headerText: "#0b1220",
      bg: "#ffffff",
      body: "linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.00))",
      incoming: "#f1f5f9",
      outgoing: "#2f6bff",
      text: "#0b1220"
    }
  },
  {
    name: "–°–∏–Ω—è—è —Ç–µ–º–∞",
    url: "https://t.me/bg/lr3hGi3U-UqyDAAArcRJk5yooy0",
    preview: {
      header: "#05233a",
      headerText: "#eaf6ff",
      bg: "#06283e",
      body: "linear-gradient(180deg, rgba(6,40,62,0.02), rgba(6,40,62,0.00))",
      incoming: "rgba(255,255,255,0.04)",
      outgoing: "#1e90ff",
      text: "#eaf6ff"
    }
  },
  {
    name: "–ó–µ–ª—ë–Ω–∞—è —Ç–µ–º–∞",
    url: "https://t.me/bg/9zHDI1iEuEoREAAASrlWw2E4vNk",
    preview: {
      header: "#072016",
      headerText: "#e6f8ef",
      bg: "#062217",
      body: "linear-gradient(180deg, rgba(6,34,23,0.02), rgba(6,34,23,0.00))",
      incoming: "rgba(255,255,255,0.04)",
      outgoing: "#2fbf6b",
      text: "#e6f8ef"
    }
  },
  {
    name: "–ö—Ä–∞—Å–Ω–∞—è —Ç–µ–º–∞",
    url: "https://t.me/bg/xwN9xVivsEq5DQAAFft1SLmXAaU",
    preview: {
      header: "#2a0b0b",
      headerText: "#ffeef0",
      bg: "#2a0b0b",
      body: "linear-gradient(180deg, rgba(42,11,11,0.02), rgba(42,11,11,0.00))",
      incoming: "rgba(255,255,255,0.04)",
      outgoing: "#ff6b6b",
      text: "#ffeef0"
    }
  }
];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ prepared message —É –±–æ—Ç–∞
async function requestPreparedMessage() {
    if (!tg || !userId) {
        console.warn('Telegram Web App or user ID is not available');
        return null;
    }
    
    // –ï—Å–ª–∏ message_id —É–∂–µ –µ—Å—Ç—å –≤ URL, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if (messageIdFromUrl) {
        console.log('Using message_id from URL:', messageIdFromUrl);
        return messageIdFromUrl;
    }
    
    try {
        console.log('Requesting prepared message from bot...');
        tg.sendData(JSON.stringify({
            action: 'get_prepared_message',
            user_id: userId
        }));
        
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–æ—Ç–∞
        // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º URL –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        return null;
    } catch (e) {
        console.error('Error requesting prepared message:', e);
        return null;
    }
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π
let completedTasks = 0;
const totalTasks = 2;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ shareMessage
function safeShareMessage() {
    if (!tg) {
        console.error('Telegram Web App is not available');
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
    if (!tg.ready || !tg.expand) {
        console.error('Telegram Web App is not fully ready');
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç–æ–¥–∞ shareMessage (–±–µ–∑ —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä—Å–∏–∏)
    if (!tg.shareMessage) {
        console.warn('shareMessage is not available in this version');
        return false;
    }
    
    return true;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–¥–∞–Ω–∏–π
const tasks = document.querySelectorAll('.task');
tasks.forEach(task => {
  task.style.cursor = 'pointer';
  task.addEventListener('click', () => {
    const type = task.dataset.task;
    const arrow = task.querySelector('.arrow');

    if (type === 'share') {
      console.log('Share button clicked, checking tg object...');
      console.log('tg available:', !!tg);
      console.log('tg.shareMessage:', tg?.shareMessage);
      console.log('tg.ready:', tg?.ready);
      
      // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –≤—ã–∑—ã–≤–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é –ø–æ—Å–ª–µ ready
      if (tg && tg.shareMessage) {
        try {
          // –ì–æ—Ç–æ–≤–∏–º —Ç–µ–∫—Å—Ç –¥–ª—è sharing
          const shareUrl = messageIdFromUrl ? 
            `${window.location.origin}${window.location.pathname}?message_id=${messageIdFromUrl}` :
            window.location.href;
          
          const fullText = shareMessageText + '\n\n' + shareUrl;
          console.log('Attempting to share:', fullText);
          
          // –í—ã–∑—ã–≤–∞–µ–º shareMessage
          tg.shareMessage(fullText);
          console.log('shareMessage called successfully');
          
        } catch (error) {
          console.error('Error calling shareMessage:', error);
          // Fallback –Ω–∞ alert
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤ 3 —á–∞—Ç–∞—Ö:\n\n' + shareMessageText);
        }
      } else {
        console.warn('shareMessage not available, using fallback');
        alert('–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤ 3 —á–∞—Ç–∞—Ö:\n\n' + shareMessageText);
        if (navigator.share) {
          navigator.share({ text: shareMessageText });
        }
      }
    } else if (type === 'subscribe') {
      if (tg && tg.openTelegramLink) {
        tg.openTelegramLink(channelUrl);
      } else {
        window.open(channelUrl, '_blank');
      }
    }

    // –ü–æ–º–µ—á–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º
    if (!arrow.classList.contains('checked')) {
      arrow.textContent = '‚úî';
      arrow.classList.add('checked');
      completedTasks++;

      if (completedTasks === totalTasks) {
        document.getElementById('doneBtn').disabled = false;
      }
    }
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ì–æ—Ç–æ–≤–æ"
document.getElementById("doneBtn").addEventListener("click", () => {
  if (completedTasks < totalTasks) return;

  const index = Math.floor(Date.now() / (1000 * 60 * 60 * 2)) % themes.length;
  const selected = themes[index];

  const header = document.querySelector('.header');
  const tasksDiv = document.querySelector('.tasks');
  const instructions = document.getElementById('instructions');
  if (header) header.style.display = 'none';
  if (tasksDiv) tasksDiv.style.display = 'none';
  if (instructions) instructions.style.display = 'none';

  const doneBtn = document.getElementById('doneBtn');
  if (doneBtn) doneBtn.style.display = 'none';

  const loader = document.getElementById('loader');
  if (loader) {
    loader.classList.add('fullscreen');
    loader.style.display = 'flex';
  }

  setTimeout(() => {
    if (loader) {
      loader.style.display = 'none';
      loader.classList.remove('fullscreen');
    }

    document.getElementById("randomTheme").textContent = "–¢–∞–¥–∞–∞–º! –í–∞—à–∞ —Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞.";
    document.getElementById("themeMessage").textContent = "–¢–µ–º—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞.";

    document.querySelector(".theme-display").style.display = "block";

    const overlay = document.querySelector('.overlay');
    const modal = document.querySelector('.modal');
    if (overlay) overlay.classList.add('fullscreen');
    if (modal) modal.classList.add('fullscreen');

    const installBtn = document.getElementById("installBtn");
    installBtn.onclick = () => {
      if (tg && tg.openLink) {
        tg.openLink(selected.url);
      } else {
        window.open(selected.url, "_blank");
      }
    };

    startFireworks(3000);
  }, 2000);
});

/* ===== –§–µ–π–µ—Ä–≤–µ—Ä–∫–∏ ===== */
function startFireworks(duration = 3000) {
  const canvas = document.getElementById('fireworks');
  if (!canvas) return;
  canvas.classList.add('fireworks-active');
  canvas.style.display = 'block';
  const ctx = canvas.getContext('2d');

  let w = canvas.width = window.innerWidth;
  let h = canvas.height = window.innerHeight;

  const particles = [];
  let animId;

  function rand(min, max) { return Math.random() * (max - min) + min; }

  function createBurst(x, y) {
    const count = 24 + Math.floor(Math.random() * 20);
    const hue = Math.floor(rand(0, 360));
    for (let i = 0; i < count; i++) {
      const speed = rand(1, 6);
      const angle = rand(0, Math.PI * 2);
      particles.push({
        x: x,
        y: y,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        life: 60 + Math.floor(rand(0, 40)),
        age: 0,
        color: `hsl(${hue + rand(-30,30)}, 80%, ${rand(50,70)}%)`
      });
    }
  }

  function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
  }

  window.addEventListener('resize', resize);

  function loop() {
    ctx.clearRect(0,0,w,h);
    if (Math.random() < 0.08) createBurst(rand(w*0.2,w*0.8), rand(h*0.15,h*0.6));

    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.vy += 0.04;
      p.x += p.vx;
      p.y += p.vy;
      p.age++;
      const t = p.age / p.life;
      const alpha = Math.max(1 - t, 0);
      ctx.globalAlpha = alpha;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, 2.2 * (1 - t) + 0.6, 0, Math.PI*2);
      ctx.fill();
      if (p.age >= p.life) particles.splice(i,1);
    }

    ctx.globalAlpha = 1;
    animId = requestAnimationFrame(loop);
  }

  createBurst(w*0.5, h*0.35);
  createBurst(w*0.7, h*0.45);
  animId = requestAnimationFrame(loop);

  setTimeout(() => {
    cancelAnimationFrame(animId);
    particles.length = 0;
    ctx.clearRect(0,0,w,h);
    canvas.style.display = 'none';
    canvas.classList.remove('fireworks-active');
    window.removeEventListener('resize', resize);
  }, duration);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', async () => {
    if (!tg) {
        console.warn('Telegram Web App is not available');
        return;
    }
    
    console.log('Telegram Web App initialized:', tg);
    console.log('User ID:', userId);
    console.log('Message ID from URL:', messageIdFromUrl);
    
    // –î–æ–∂–∏–¥–∞–µ–º—Å—è –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TMA
    if (tg.ready) {
        tg.ready();
        console.log('TMA is ready');
    }
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º prepared message –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    await requestPreparedMessage();
});
